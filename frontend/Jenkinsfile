pipeline {
    agent any
    
    stages {
        stage("frontend"){
            parallel{
                stage("test"){
                    steps{
                        sh 'docker build -t front-test -f ./frontend/Dockerfile.dev ./frontend'
                        // sh 'docker run front-test npm run test'
                    }
                    post {
                        success{
                            sh 'echo test 성공!!'
                        }
                    }
                }
                stage("build"){
                    steps {
                        script{
                            try {
                                sh 'docker stop wlsgh97/nahonsan-frontend'
                                sh 'docker rm wlsgh97/nahonsan-frontend'
                            } catch (e) {
                                sh 'echo "fail to stop and remove container"'
                            }
                        }
                        
                        
                        sh 'docker build -t wlsgh97/nahonsan-frontend ./frontend --build-arg KAKAO_ID=${KAKAO_ID} --build-arg NAVER_ID=${NAVER_ID} --build-arg GOOGLE_ID=${GOOGLE_ID}'
                        sh 'echo "$DOCKER_HUB_PASSWORD" | docker login -u "$DOCKER_HUB_ID" --password-stdin'
                        echo 'Build image...'
                        sh "docker push wlsgh97/nahonsan-frontend"
                        sh "docker run -d -p 80:3000 wlsgh97/nahonsan-frontend"
                    }
                }
            }
        }
        
        // stage('Clean image') {
        //     steps {
        //         sh 'docker rm -f `docker ps -aq --filter="wlsgh97/nahonsan-frontend"`'
        //         echo 'Clean image...'
        //     }
        // }
    }
}